<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Headline Strengthener — AI</title>
  <style>
    :root{
      --bg-1:#f2f2f2;
      --panel:#ffffff;
      --muted:#bdbdbd;
      --ink:#111;
      --accent:#000;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg-1);
      color:var(--ink);
      padding:36px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      /* optional background image: create 'background.jpg' in same folder or change URL */
      background-image: url('background.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    .card{
      max-width:960px;
      margin: auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(250,250,250,0.96));
      border-radius:12px;
      padding:28px;
      box-shadow:0 10px 30px rgba(0,0,0,0.08);
      border:1px solid #e4e4e4;
    }

    h1{margin:0 0 8px 0; font-size:20px; color:var(--accent);}
    p.lead{margin:0 0 20px 0; color:#333; font-size:14px;}

    textarea{
      width:100%;
      min-height:96px;
      resize:vertical;
      padding:12px 14px;
      border-radius:8px;
      border:1px solid #cfcfcf;
      background:#fafafa;
      font-size:15px;
      color:var(--ink);
    }

    .controls{display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap;}
    button{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
    }
    button.secondary{
      background:#222;
      opacity:0.9;
    }
    .muted{color:var(--muted); font-size:13px;}

    .layout{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
      margin-top:18px;
    }

    .panel{
      background:var(--panel);
      border-radius:10px;
      padding:14px;
      border:1px solid #e8e8e8;
      min-height:120px;
    }

    #result{white-space:pre-wrap; font-size:14px; line-height:1.55;}

    #historyBox{max-height:420px; overflow:auto; font-size:13px;}
    .hist-item{padding:10px;border-bottom:1px dashed #eee;}
    .hist-item strong{display:block;margin-bottom:6px;}

    .debug{margin-top:12px; font-family:monospace; font-size:12px; color:#444; background:#fafafa; padding:8px; border-radius:6px; border:1px solid #eee; overflow:auto; max-height:180px;}
    .small{font-size:12px; color:#666;}
    label.switch{display:inline-flex; align-items:center; gap:8px; cursor:pointer; font-size:13px;}

    @media (max-width:900px){
      .layout{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Headline Strengthener — AI</h1>
    <p class="lead">Paste a headline and get a score, line-by-line feedback, and 3 alternative rewrites. Uses sensory adjective, verb, noun, contrast/tension, rhythm, and emotional payoff as evaluation criteria.</p>

    <textarea id="headlineInput" placeholder="Type your headline here..."></textarea>

    <div class="controls">
      <button id="analyzeBtn">Analyze</button>
      <button id="rewriteBtn" class="secondary">Rewrite (3 options)</button>
      <label class="switch"><input type="checkbox" id="showRaw" /> <span class="muted">Show raw API JSON</span></label>
      <div style="flex:1"></div>
      <div class="small">Model: <strong>gpt-4o-mini</strong> · Temp: <strong id="tempLabel">0.7</strong></div>
    </div>

    <div class="layout">
      <div class="panel">
        <h2 style="margin:0 0 8px 0; font-size:15px;">Analysis</h2>
        <div id="result" aria-live="polite">Enter a headline and click Analyze.</div>

        <div id="debug" class="debug" style="display:none;"></div>
      </div>

      <div class="panel">
        <h2 style="margin:0 0 8px 0; font-size:15px;">History</h2>
        <div id="historyBox"><div class="muted">No history yet.</div></div>
      </div>
    </div>
  </div>

  <script>
    // -------------------------
    // CONFIGURE:
    // If you are testing locally you can put your key here (NOT recommended for production).
    // Better: set up a server endpoint that proxies requests and hides the key.
    // Example server endpoint (recommended): POST /api/ai/headline -> server calls OpenAI with SECRET_KEY
    // For quick local tests only, replace below value. Do NOT commit API keys to public repos.
    // -------------------------
    const CLIENT_SIDE_OPENAI_KEY = "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"; // <--- Replace for quick tests OR call your own server below.
    const USE_SERVER_PROXY = false; // set true if you want to call your server endpoint instead of directly calling OpenAI
    const SERVER_PROXY_URL = "/api/ai/headline"; // change to your proxy route if USE_SERVER_PROXY=true

    // -------------------------
    // UI
    // -------------------------
    const analyzeBtn = document.getElementById("analyzeBtn");
    const rewriteBtn = document.getElementById("rewriteBtn");
    const headlineInput = document.getElementById("headlineInput");
    const resultEl = document.getElementById("result");
    const historyBox = document.getElementById("historyBox");
    const debugEl = document.getElementById("debug");
    const showRawCheckbox = document.getElementById("showRaw");
    const tempLabel = document.getElementById("tempLabel");

    let history = [];

    analyzeBtn.addEventListener("click", () => analyzeHeadline("analysis"));
    rewriteBtn.addEventListener("click", () => analyzeHeadline("rewrite"));

    // -------------------------
    // Helper: local fallback analysis (fast feedback if API not reachable)
    // -------------------------
    function localQuickAnalysis(headline){
      const sensory = ["soft","crisp","breezy","warm","cool","raw","smooth","airy","textured","silky","earthy","tactile"];
      const verbs = ["feel","wrap","reveal","breathe","define","meet","transform","turn","weave","hold"];
      const nouns = ["linen","fabric","summer","comfort","touch","skin","weave","loom","texture","thread"];

      const text = headline.toLowerCase();
      const hasSensory = sensory.some(s => text.includes(s));
      const hasVerb = verbs.some(v => text.includes(v));
      const hasNoun = nouns.some(n => text.includes(n));
      const words = headline.trim().split(/\s+/).filter(Boolean).length;

      const score = Math.round(
        (hasSensory*30 + hasVerb*25 + hasNoun*25 + (words<=7?20: Math.max(0,20 - (words-7)*3)))
      );

      let suggestions = [];
      if(!hasSensory) suggestions.push("Add a sensory adjective (e.g. 'breezy', 'silky', 'crisp') to make it more vivid.");
      if(!hasVerb) suggestions.push("Include a strong verb to create action or movement.");
      if(!hasNoun) suggestions.push("Add a concrete noun (linen, weave, summer) to anchor the idea.");
      if(words>12) suggestions.push("Tighten the headline — shorter lines read stronger.");

      return {
        score,
        notes: [
          `Sensory present: ${hasSensory ? "yes" : "no"}`,
          `Strong verb present: ${hasVerb ? "yes" : "no"}`,
          `Concrete noun present: ${hasNoun ? "yes" : "no"}`,
          `Rhythm / length (words): ${words}`
        ],
        suggestions,
        rewrites: [
          `${headline} — trimmed & sensory`,
          `Silky ${headline}`,
          `When linen ${headline}`
        ]
      };
    }

    // -------------------------
    // Main function: calls OpenAI (or proxy) and renders result
    // -------------------------
    async function analyzeHeadline(mode = "analysis"){
      const headline = headlineInput.value.trim();
      if(!headline){
        resultEl.textContent = "Please enter a headline to analyze.";
        return;
      }

      resultEl.textContent = "Thinking...";

      // Construct a deterministic, explicit prompt so model MUST use the headline string
      const systemPrompt = `
You are an expert creative director and copywriter. When given a single headline you must:
1) Score the headline from 0-100.
2) Provide 6 short bullet observations: sensory adjective present (yes/no), verb present (yes/no), concrete noun present (yes/no), contrast/tension (yes/no), rhythm/length comment, emotional payoff present (yes/no).
3) Provide 4 short, concrete suggestions to improve the headline.
4) Provide 3 alternative rewrites (short, punchy, varied tones).
5) Keep output clear and machine-parsable: start with "SCORE: <number>" and label sections "OBSERVATIONS:", "SUGGESTIONS:", "REWRITES:".
Do not add unrelated commentary. Always reference the exact headline given.
`;

      const userInstruction = mode === "rewrite"
        ? `Rewrite this headline stronger (3 variants). Headline: "${headline}"`
        : `Analyze this headline and follow the format above. Headline: "${headline}"`;

      try {
        let apiResponseJson = null;

        if(USE_SERVER_PROXY){
          // Call user's server proxy endpoint (recommended for production)
          const proxyResp = await fetch(SERVER_PROXY_URL, {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ prompt: userInstruction, system: systemPrompt, mode, headline })
          });
          apiResponseJson = await proxyResp.json();
        } else {
          // Direct client-side call to OpenAI (for quick dev/test only)
          if(!CLIENT_SIDE_OPENAI_KEY || CLIENT_SIDE_OPENAI_KEY === "YOUR_API_KEY_HERE"){
            // No key provided: fallback to local quick analysis (helpful during development)
            const fallback = localQuickAnalysis(headline);
            renderAnalysisFromObject(fallback, headline);
            debugEl.style.display = "block";
            debugEl.textContent = "No client API key provided. Showing local quick analysis fallback.";
            return;
          }

          const payload = {
            model: "gpt-4o-mini",
            messages: [
              { role: "system", content: systemPrompt },
              { role: "user", content: userInstruction }
            ],
            temperature: 0.7,
            max_tokens: 520,
            n: 1
          };

          const resp = await fetch("https://api.openai.com/v1/chat/completions", {
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "Authorization":"Bearer " + CLIENT_SIDE_OPENAI_KEY
            },
            body: JSON.stringify(payload)
          });

          apiResponseJson = await resp.json();
        }

        // Robust parsing of response
        const rawText =
          apiResponseJson?.choices?.[0]?.message?.content ||
          apiResponseJson?.choices?.[0]?.text ||
          apiResponseJson?.text ||
          (typeof apiResponseJson === "string" ? apiResponseJson : null);

        if(!rawText){
          resultEl.textContent = "AI returned empty response. See debug for raw JSON.";
          debugEl.style.display = "block";
          debugEl.textContent = JSON.stringify(apiResponseJson,null,2);
          return;
        }

        // Show raw JSON if user opted in
        if(showRawCheckbox.checked){
          debugEl.style.display = "block";
          debugEl.textContent = JSON.stringify(apiResponseJson,null,2);
        } else {
          debugEl.style.display = "none";
        }

        // Render the returned text as-is (we required machine-parsable structure in prompt)
        resultEl.textContent = rawText;

        // Save history
        history.unshift({ headline, response: rawText, time: (new Date()).toLocaleString() });
        renderHistory();

      } catch (err){
        console.error(err);
        // If network / API errors, show local quick analysis as graceful fallback
        const fallback = localQuickAnalysis(headline);
        resultEl.textContent = "Error calling AI — showing local quick analysis instead.\n\n" + formatLocalResult(fallback);
        debugEl.style.display = "block";
        debugEl.textContent = "Error object:\n" + (err && err.message ? err.message : String(err));
      }
    }

    function formatLocalResult(obj){
      return `SCORE: ${obj.score}\n\nOBSERVATIONS:\n- ${obj.notes.join("\n- ")}\n\nSUGGESTIONS:\n- ${obj.suggestions.join("\n- ")}\n\nREWRITES:\n- ${obj.rewrites.join("\n- ")}`;
    }

    function renderAnalysisFromObject(obj, headline){
      resultEl.textContent = formatLocalResult(obj);
      history.unshift({ headline, response: resultEl.textContent, time: (new Date()).toLocaleString() });
      renderHistory();
    }

    function renderHistory(){
      if(history.length === 0){
        historyBox.innerHTML = '<div class="muted">No history yet.</div>';
        return;
      }
      historyBox.innerHTML = history.map(h => {
        return `<div class="hist-item"><strong>${escapeHtml(h.headline)}</strong><div class="small muted">${h.time}</div><div style="margin-top:8px; font-size:13px;">${escapeHtml(h.response).replace(/\n/g,"<br>")}</div></div>`;
      }).join("");
    }

    function escapeHtml(s){
      return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    // Quick tip: press Ctrl+Enter in textarea to analyze
    headlineInput.addEventListener("keydown", (e)=> {
      if(e.key === "Enter" && (e.ctrlKey || e.metaKey)){
        analyzeHeadline("analysis");
      }
    });
  </script>
</body>
</html>
