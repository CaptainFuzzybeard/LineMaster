<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Headline Strengthener</title>
  <style>
    :root{--bg:#f2f2f2;--card:#fff;--muted:#bfbfbf;--text:#111;--black:#000}
    *{box-sizing:border-box}
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      padding: 40px;
      background: linear-gradient(180deg,var(--bg),#e9e9e9);
      color: var(--text);
    }
    .container {
      max-width: 880px;
      margin: auto;
      background: var(--card);
      padding: 28px;
      border-radius: 12px;
      border: 1px solid #dcdcdc;
      box-shadow: 0 6px 30px rgba(0,0,0,0.04);
    }
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0;color:var(--black)}
    p.lead{margin:6px 0 0;color:var(--muted);font-size:13px}

    .controls{display:flex;gap:12px;margin-top:8px;align-items:center}
    textarea{
      width:100%;min-height:92px;padding:12px;border-radius:8px;border:1px solid #d0d0d0;background:#fbfbfb;font-size:15px;color:var(--text);resize:vertical
    }

    .row{display:flex;gap:16px}
    .col{flex:1}
    .sidebar{width:320px}

    .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:#000;color:#fff}
    .btn-ghost{background:transparent;border:1px solid #ccc;color:var(--text)}

    .result{
      margin-top:18px;padding:16px;border-radius:8px;background:#f7f7f7;border:1px solid #e0e0e0;white-space:pre-wrap;line-height:1.45;color:var(--text)
    }

    .history{margin-top:12px;max-height:360px;overflow:auto;padding-right:6px}
    .hist-item{padding:10px;border-radius:8px;border:1px solid #eee;margin-bottom:10px;background:white}
    .muted{color:var(--muted);font-size:13px}

    .small{font-size:13px}

    /* background image helper: use body[data-bg] to show image behind page */
    body[data-bg]::before{
      content:"";position:fixed;inset:0;z-index:-1;opacity:.18;background-size:cover;background-position:center;filter:grayscale(.05) contrast(.9);
    }

    @media (max-width:880px){.row{flex-direction:column}.sidebar{width:auto}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Headline Strengthener</h1>
        <p class="lead">Paste a headline and get instant AI feedback — sensory adjective, verb, noun, contrast, rhythm, emotional payoff, and a score.</p>
      </div>
      <div class="small muted">Black · Light-grey theme</div>
    </header>

    <div class="row">
      <div class="col">
        <label class="small muted">Your headline</label>
        <textarea id="headlineInput" placeholder="Type your headline here — e.g. 'Breezy Linen That Breathes Like Summer'"> </textarea>

        <div class="controls">
          <button class="btn btn-primary" onclick="analyzeHeadline('analysis')">Analyze</button>
          <button class="btn btn-ghost" onclick="analyzeHeadline('rewrite')">Rewrite Stronger</button>
          <button class="btn" onclick="clearAll()">Clear</button>
        </div>

        <div id="result" class="result" style="display:none"></div>
      </div>

      <aside class="sidebar">
        <div class="muted small">History</div>
        <div id="historyBox" class="history"></div>

        <div style="margin-top:12px" class="muted small">Settings</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <label class="small muted">Background image</label>
          <input id="bgInput" type="file" accept="image/*" onchange="loadBackground(event)" />
        </div>

        <p class="muted small" style="margin-top:10px">Important: Do NOT put your OpenAI API key in client-side code for production. See notes below for a safe proxy example.</p>
      </aside>
    </div>

    <footer style="margin-top:18px;color:var(--muted);font-size:13px">
      <strong>How it works:</strong> the page sends the headline to your configured AI endpoint and renders the model's suggestions. For local testing you can paste your API key into the local dev proxy (example included). In production, run a server-side proxy to keep the key secret.
    </footer>

    <section style="margin-top:14px">
      <details>
        <summary class="small">Developer notes & safe proxy (click to expand)</summary>
        <div class="muted small" style="margin-top:8px">
          <p><strong>Client-side behavior</strong>: This page calls a configured endpoint (see `AI_ENDPOINT` below). It does not hardcode an API key. If you put the OpenAI key directly in the page, browsers will reuse the same key, but more importantly you'll expose the key to anyone who views the site — don't do that in production.</p>

          <p><strong>Why you saw the same response earlier</strong>: Most common causes are (1) the page was calling a cached/stubbed endpoint that returned a static string; (2) the request body didn't include the user's headline properly; or (3) the response parsing used a constant fallback. This version constructs explicit messages with the headline inserted and renders the returned text directly.</p>

          <p><strong>Minimal Node.js proxy (example)</strong> — create a small server so your frontend calls <code>/ai</code> and the server forwards to OpenAI with the key kept on the server:</p>

<pre style="background:#f3f3f3;padding:10px;border-radius:6px;overflow:auto;font-size:13px">// server.js
const express = require('express');
const fetch = require('node-fetch');
const app = express();
app.use(express.json());
const OPENAI_KEY = process.env.OPENAI_KEY;
app.post('/ai', async (req, res) => {
  try {
    const payload = req.body; // forward body as-is
    const r = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_KEY}` },
      body: JSON.stringify(payload)
    });
    const json = await r.json();
    res.status(r.status).json(json);
  } catch (e) { res.status(500).json({ error: e.message }); }
});
app.listen(3000);
</pre>

<p class="muted small">Then set <code>AI_ENDPOINT</code> in the client JS to <code>http://localhost:3000/ai</code> while testing.</p>
        </div>
      </details>
    </section>
  </div>

  <script>
    // --- CONFIG ---
    // If you are testing locally with a proxy server (recommended), set AI_ENDPOINT to your server.
    // Example: const AI_ENDPOINT = 'http://localhost:3000/ai';
    // If you absolutely must call OpenAI directly from the browser (not recommended), you can set
    // AI_ENDPOINT to 'https://api.openai.com/v1/chat/completions' and then include an Authorization header
    // with a key — but again: this exposes the key to anyone who inspects the site.
    const AI_ENDPOINT = '';

    // --- helper functions ---
    const history = [];
    const historyBox = () => document.getElementById('historyBox');

    function clearAll(){
      document.getElementById('headlineInput').value = '';
      document.getElementById('result').style.display='none';
    }

    function loadBackground(evt){
      const file = evt.target.files && evt.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const url = e.target.result;
        // apply as low-opacity fixed background
        document.body.setAttribute('data-bg','true');
        document.body.style.setProperty('--bg-image', `url(${url})`);
        document.body.style.backgroundImage = `url(${url})`;
        // also set pseudo-element via inline style
        const styleEl = document.getElementById('bgStyle') || document.createElement('style');
        styleEl.id = 'bgStyle';
        styleEl.textContent = `body::before{background-image: url(${url});}`;
        document.head.appendChild(styleEl);
      };
      reader.readAsDataURL(file);
    }

    // Compose the messages for the model clearly so each call is unique per headline.
    function buildPayload(mode, headline){
      const userInstruction = mode === 'rewrite' ?
        `Rewrite this headline to be stronger, using sensory language, a vivid verb, a concrete noun, contrast, rhythm, and a clear emotional payoff. Keep it short (<=10 words) and give 3 variants.` :
        `Analyse this headline for sensory adjective, verb, noun, contrast/tension, rhythm, and emotional payoff. Give a numeric score (0-100), a short explanation for each criterion, and 3 suggested tweaks.`;

      return {
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: 'You are an expert creative director. Be concise, actionable, and kind.' },
          { role: 'user', content: `${userInstruction}\n\nHeadline: "${headline.replace(/"/g,'\"')}"` }
        ],
        max_tokens: 400,
        temperature: 0.7
      };
    }

    async function analyzeHeadline(mode = 'analysis'){
      const input = document.getElementById('headlineInput');
      const result = document.getElementById('result');
      const headline = input.value.trim();
      if(!headline){ result.style.display='block'; result.textContent='Please enter a headline to analyse.'; return; }

      result.style.display='block'; result.textContent='Thinking...';

      // Build payload
      const payload = buildPayload(mode, headline);

      try{
        // Validate AI_ENDPOINT
        if(!AI_ENDPOINT){
          result.innerHTML = "<strong>Client not configured:</strong> set <code>AI_ENDPOINT</code> in the page to your proxy (e.g. http://localhost:3000/ai).<br><br>To test quickly you can temporarily paste your OpenAI key and endpoint into the proxy server (server-side) as shown in the developer notes.";
          return;
        }

        const fetchOptions = {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        };

        // If you're deliberately calling the OpenAI REST endpoint directly (again: not recommended),
        // include the Authorization header here. Example commented out:
        // fetchOptions.headers['Authorization'] = 'Bearer YOUR_OPENAI_KEY';

        const resp = await fetch(AI_ENDPOINT, fetchOptions);
        if(!resp.ok){
          const text = await resp.text();
          throw new Error(`AI endpoint error: ${resp.status} ${text}`);
        }

        const data = await resp.json();

        // Chat completions reply may differ by API; try common shapes safely
        let aiText = '';
        if(data.choices && data.choices[0] && data.choices[0].message){ aiText = data.choices[0].message.content; }
        else if(data.output && Array.isArray(data.output) && data.output[0] && data.output[0].content){
          // newer responses API shape
          const c = data.output[0].content.find(x=>x.type==='output_text');
          aiText = c ? c.text : JSON.stringify(data.output[0].content);
        } else if(typeof data === 'string') aiText = data;
        else aiText = JSON.stringify(data, null, 2);

        result.textContent = aiText;

        // save to history
        history.unshift({headline, mode, time: new Date().toISOString(), aiText});
        renderHistory();

      }catch(err){
        console.error(err);
        result.textContent = 'Error: ' + (err.message || err);
      }
    }

    function renderHistory(){
      const hb = historyBox();
      hb.innerHTML = history.map(h => `<div class='hist-item'><div style='font-weight:600'>${escapeHtml(h.headline)}</div><div class='muted small'>${h.mode} • ${new Date(h.time).toLocaleString()}</div><div style='margin-top:8px;white-space:pre-wrap'>${escapeHtml(h.aiText)}</div></div>`).join('');
    }

    function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  </script>
</body>
</html>
